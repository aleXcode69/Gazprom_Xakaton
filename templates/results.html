<!DOCTYPE html>
<html>
<head>
    <title>Результаты анализа</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <h1>Результаты анализа данных: {{ filename }}</h1>

    <div class="section">
        <h2>Общая информация</h2>
        <div class="metric">Размер файла: {{ file_size_kb }} KB</div>
        <div class="metric">Количество строк: {{ row_count }}</div>
        <div class="metric">Количество столбцов: {{ col_count }}</div>
    </div>

    <div class="section">
        <h2>Пропущенные значения</h2>
        <div class="metric">Всего пропущенных значений: {{ total_missing }}</div>
        <div class="metric">Строк с пропущенными значениями: {{ rows_with_missing }}</div>
        <table>
            <tr><th>Столбец</th><th>Пропущено</th><th>% пропущено</th></tr>
            {% for col, count, pct in missing_values %}
            <tr><td>{{ col }}</td><td>{{ count }}</td><td>{{ "%.2f"|format(pct) }}%</td></tr>
            {% endfor %}
        </table>
    </div>

    <div class="section">
        <h2>Дубликаты</h2>
        <div class="metric">
            Полных дубликатов строк: {{ full_duplicates }}
            {% if full_duplicates > 0 %}
            <form action="/process_duplicates" method="post" style="display: inline;">
                <input type="hidden" name="filename" value="{{ filename }}">
                <input type="hidden" name="action" value="remove_full">
                <button type="submit">Удалить полные дубликаты</button>
            </form>
            {% endif %}
        </div>

        <div class="merge-section">
            <h3>Анализ частичных дубликатов</h3>

            {% for col_info in partial_duplicates_info %}
            <div class="column-info">
                <strong>{{ col_info.column }}</strong>:
                {{ col_info.duplicate_groups }} групп частичных дубликатов
                (всего {{ col_info.duplicate_rows }} строк)

                <form action="/process_duplicates" method="post" style="display: inline-block; margin-left: 15px;">
                    <input type="hidden" name="filename" value="{{ filename }}">
                    <input type="hidden" name="action" value="merge_partial">
                    <input type="hidden" name="column" value="{{ col_info.column }}">

                    <div class="merge-options">
                        <label>Стратегия объединения для {{ col_info.column }}:</label>
                        <select name="merge_strategy">
                            <option value="first">Оставить первое значение</option>
                            <option value="last">Оставить последнее значение</option>
                            <option value="concat">Объединить значения (через запятую)</option>
                        </select>
                    </div>

                    <button type="submit">Объединить дубликаты по этому полю</button>
                </form>
            </div>
            {% endfor %}

            {% if partial_duplicates_samples %}
            <h4>Примеры групп частичных дубликатов:</h4>
            {% for sample in partial_duplicates_samples %}
            <div class="duplicate-group">
                <table>
                    <tr>
                        {% for col in sample.columns %}
                        <th>{{ col }}</th>
                        {% endfor %}
                    </tr>
                    {% for idx, row in sample.iterrows() %}
                    <tr>
                        {% for val in row %}
                        <td>{{ val }}</td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </table>
            </div>
            {% endfor %}
            {% endif %}
        </div>
    </div>

    <div class="section">
        <h2>Статистика по столбцам</h2>
        <table>
            <tr><th>Столбец</th><th>Тип данных</th><th>Уникальных значений</th><th>Пример значения</th></tr>
            {% for col, dtype, unique, sample in column_stats %}
            <tr {% if col in top_columns %}class="highlight"{% endif %}>
                <td>{{ col }}</td><td>{{ dtype }}</td><td>{{ unique }}</td><td>{{ sample }}</td>
            </tr>
            {% endfor %}
        </table>
    </div>

    {% if processed %}
    <div class="section">
        <h2>Обработанные данные</h2>
        <form action="/download" method="post">
            <input type="hidden" name="filename" value="{{ filename }}">
            <button type="submit">Скачать обработанный файл</button>
        </form>
    </div>
    {% endif %}

    <a href="/">Загрузить другой файл</a>
</body>
</html>